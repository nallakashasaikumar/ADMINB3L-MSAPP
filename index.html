<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>B3LAMS — Admin Dashboard (Frontend Only)</title>
  <link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#000000">
  <link rel="icon" type="image/png" href="icons/icon-512.png">

<style>
:root{
  --gold:#ffd86b; --bg:#070707; --card:#0f0f12; --muted:#b5a96d;
  --glass: rgba(255,255,255,0.02);
}
*{box-sizing:border-box;font-family:Inter,system-ui,Arial,sans-serif}
html,body{height:100%;margin:0;background:linear-gradient(180deg,#050505,#0b0b0b);color:#fff}
a{color:inherit}
.header{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;padding:12px 16px;background:#0f0f11;border-bottom:1px solid rgba(255,216,107,0.04);
  position:sticky;top:0;z-index:20;
}
.header-left{display:flex;gap:12px;align-items:center}
.logo{font-weight:800;color:var(--gold);font-size:1.05rem}
.sub{color:var(--muted);font-size:13px}
.header-actions{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--gold),#f3a847);color:#111;font-weight:700;cursor:pointer}
.link-btn{background:transparent;border:1px solid rgba(255,255,255,0.06);color:#fff;padding:8px 10px;border-radius:8px;cursor:pointer}
.badge{background:rgba(0,0,0,0.35);padding:6px 8px;border-radius:8px;color:var(--gold);font-weight:600}

/* layout */
.container{max-width:1200px;margin:16px auto;padding:12px;width:100%;display:grid;grid-template-columns:1fr 340px;gap:16px}
@media(max-width:980px){.container{grid-template-columns:1fr;padding:12px 10px}}

/* cards and lists */
.cards{display:flex;gap:12px;margin-bottom:12px;flex-wrap:wrap}
.card{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.01));padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,0.03)}
.card h3{margin:4px 0 8px}
.card p{margin:8px 0 0;font-weight:800;font-size:20px;color:var(--gold)}
.list-item{display:flex;gap:10px;align-items:center;padding:10px;border-radius:8px;border-bottom:1px solid rgba(255,255,255,0.02)}
.img-thumb{width:70px;height:70px;border-radius:8px;object-fit:cover}
.controls{display:flex;gap:6px;flex-direction:column}

/* form controls */
input,select,textarea{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #222;background:#0d0d0d;color:#fff}
small.kv{color:var(--muted);font-size:13px}
.filters{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
.filters input, .filters select {width:auto;min-width:160px}

/* tabs */
.tabs{display:flex;gap:8px;margin:10px 0;flex-wrap:wrap}
.tab{padding:8px 10px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.04);cursor:pointer}
.tab.active{background:#111;border:1px solid rgba(255,216,107,0.14);color:var(--gold)}

/* sidebar */
.sidebar .card{margin-bottom:12px}
.scroll{max-height:340px;overflow:auto;padding-right:6px}

/* responsive */
@media(max-width:600px){
  .img-thumb{width:56px;height:56px}
  .container{grid-template-columns:1fr}
}

/* toast */
.toast {
  position: fixed; bottom: 24px; left: 50%; transform: translateX(-50%);
  background: #00d48f; color: #07110a; padding: 10px 18px; border-radius: 28px; font-weight:700; z-index: 99999; opacity: 0; transition: opacity .25s ease;
}

/* modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;z-index:99999}
.modal-card{background:#0c0c0c;padding:16px;border-radius:12px;max-width:92%;max-height:92%;overflow:auto;color:#fff}
.table-lite{width:100%;border-collapse:collapse}
.table-lite td,.table-lite th{padding:6px;border-bottom:1px solid rgba(255,255,255,0.02)}
.status-pill{padding:6px 8px;border-radius:999px;font-weight:700;background:rgba(255,255,255,0.02);color:var(--muted);border:1px solid rgba(255,255,255,0.02)}
.status-active{color:#0f0;background:rgba(15,255,15,0.06)}
</style>
</head>
<body>

<header class="header">
  <div class="header-left">
    <div class="logo">B3LAMS</div>
    <div>
      <div style="font-weight:700">BHARATH ECOMMERCE LARGEST MEGA SHOP — Admin</div>
      <div class="sub">Frontend-only admin — localStorage sync with Buyer</div>
    </div>
  </div>

  <div class="header-actions">
    <div class="badge" id="adminNameBadge">Admin</div>
    <button class="link-btn" onclick="showTab('dashboard')">Dashboard</button>
    <button class="link-btn" onclick="showTab('products')">Products</button>
    <button class="link-btn" onclick="showTab('buyers')">Buyers</button>
    <button class="link-btn" onclick="showTab('orders')">Orders</button>
    <!-- default buyer link: change if you host buyer elsewhere -->
    <button class="btn" onclick="gotoBuyer()">Open Buyer App</button>
    <button class="link-btn" onclick="logout()">Logout</button>
  </div>
</header>

<main class="container">
  <div>
    <div class="cards" id="topCards">
      <div class="card"><h4>Total products</h4><p id="cntProducts">0</p></div>
      <div class="card"><h4>Total buyers</h4><p id="cntBuyers">0</p></div>
      <div class="card"><h4>Total orders</h4><p id="cntOrders">0</p></div>
      <div class="card"><h4>Total earnings</h4><p id="cntEarnings">₹0</p></div>
    </div>

    <div class="card filters">
      <input id="searchQ" placeholder="Search product name or category" oninput="applyFilters()">
      <select id="filterCategory" onchange="applyFilters()"><option value="__all">All categories</option></select>
      <select id="sortPrice" onchange="applyFilters()">
        <option value="none">Sort: None</option>
        <option value="price_asc">Price: Low → High</option>
        <option value="price_desc">Price: High → Low</option>
      </select>
      <button class="link-btn" onclick="resetFilters()">Reset</button>
    </div>

    <div class="tabs" role="tablist">
      <div class="tab active" id="tab-products" onclick="showTab('products')">Products</div>
      <div class="tab" id="tab-buyers" onclick="showTab('buyers')">Buyers</div>
      <div class="tab" id="tab-orders" onclick="showTab('orders')">Orders</div>
      <div class="tab" id="tab-dashboard" onclick="showTab('dashboard')">Dashboard</div>
    </div>

    <!-- product form -->
    <section id="section-products" class="card" style="display:block">
      <h3 id="formTitle">Add / Edit Product</h3>
      <input id="pid" type="hidden">
      <input id="pname" placeholder="Product name">
      <input id="pprice" placeholder="Price (numeric)" type="number" min="0">
      <input id="pcat" placeholder="Category (Mobiles, Fashion, Electronics...)">
      <input id="plink" placeholder="External buy link (optional)">
      <input id="pimageurl" placeholder="Image URL (use if hosting images externally)">
      <div style="margin:6px 0">
        <label class="kv">Or upload images (converted to base64):</label>
        <input id="pfiles" type="file" accept="image/*" multiple>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="kv">Status:</label>
        <select id="pstatus">
          <option value="active">Active</option>
          <option value="inactive">Inactive</option>
        </select>
        <label class="kv">Stock:</label>
        <input id="pstock" type="number" value="100" style="width:120px">
      </div>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="saveBtn" onclick="saveProduct()">Save Product</button>
        <button class="link-btn" onclick="clearForm()">Clear</button>
      </div>
    </section>

    <section id="section-products-list" class="card" style="margin-top:12px">
      <h3>Products <small class="kv" id="productCountInfo"></small></h3>
      <div id="productsList" class="scroll"></div>
    </section>

    <section id="section-buyers" class="card" style="display:none;margin-top:12px">
      <h3>Buyers</h3>
      <div id="buyersList" class="scroll"></div>
    </section>

    <section id="section-orders" class="card" style="display:none;margin-top:12px">
      <h3>Orders</h3>
      <div id="ordersList" class="scroll"></div>
    </section>
  </div>

  <!-- sidebar -->
  <aside class="sidebar">
    <div class="card">
      <h4>Quick Stats</h4>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <div><strong>Products:</strong> <span id="statProducts">0</span></div>
        <div><strong>Active:</strong> <span id="statActive">0</span></div>
        <div><strong>Inactive:</strong> <span id="statInactive">0</span></div>
        <div><strong>Buyers:</strong> <span id="statBuyers">0</span></div>
        <div><strong>Orders:</strong> <span id="statOrders">0</span></div>
      </div>
    </div>

    <div class="card">
      <h4>Recent Orders</h4>
      <div id="recentOrders" class="scroll"></div>
    </div>

    <div class="card">
      <h4>Actions</h4>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button onclick="exportData()">Export JSON</button>
        <button onclick="importPrompt()">Import JSON</button>
        <button onclick="clearAllData()" style="background:#b83d3d;color:#fff">Clear All (danger)</button>
      </div>
    </div>
  </aside>
</main>

<div id="toastRoot" aria-hidden="true"></div>

<!-- simple login modal (used if no admin session) -->
<div id="loginModal" style="display:none"></div>

<script>
/* Keys used by Buyer too:
   - b3_products
   - b3_buyers
   - b3_orders
   - b3_currentAdmin (admin session)
*/

const KEY_PRODUCTS = 'b3_products';
const KEY_BUYERS = 'b3_buyers';
const KEY_ORDERS = 'b3_orders';
const KEY_ADMIN = 'b3_currentAdmin';

// utility read/write
function readJSON(k, fallback){ try { const v = localStorage.getItem(k); return v ? JSON.parse(v) : (fallback||[]); } catch(e){ return fallback||[]; } }
function writeJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); window.dispatchEvent(new Event('storage')); }

// toast
function showToast(msg, ms=1400){
  const root = document.getElementById('toastRoot');
  const t = document.createElement('div'); t.className='toast'; t.textContent = msg; root.appendChild(t);
  requestAnimationFrame(()=> t.style.opacity = '1');
  setTimeout(()=> t.style.opacity = '0', ms);
  setTimeout(()=> t.remove(), ms+300);
}

// ensure admin is logged in; if not show quick login
let admin = readJSON(KEY_ADMIN, null);
function ensureAdmin(){
  admin = readJSON(KEY_ADMIN, null);
  if(!admin){
    showLoginModal();
  } else {
    document.getElementById('adminNameBadge').textContent = admin.name || admin.email || 'Admin';
  }
}

// login modal
function showLoginModal(){
  const modal = document.createElement('div');
  modal.className = 'modal-backdrop';
  modal.innerHTML = `<div class="modal-card">
    <h3>Admin sign in</h3>
    <p class="kv">No backend — a local admin session will be created in your browser (localStorage).</p>
    <p><input id="admName" placeholder="Admin name (eg. Sai)"></p>
    <p><input id="admEmail" placeholder="Email (optional)"></p>
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
      <button onclick="createAdmin()" class="btn">Create Admin</button>
      <button onclick="document.body.removeChild(this.closest('.modal-backdrop'))" class="link-btn">Cancel</button>
    </div>
  </div>`;
  document.body.appendChild(modal);
}
function createAdmin(){
  const name = (document.getElementById('admName')||{value:''}).value.trim() || 'Admin';
  const email = (document.getElementById('admEmail')||{value:''}).value.trim() || '';
  const adm = { id: 'adm_'+Date.now(), name, email, created: new Date().toISOString() };
  localStorage.setItem(KEY_ADMIN, JSON.stringify(adm));
  document.body.querySelectorAll('.modal-backdrop').forEach(n=>n.remove());
  ensureAdmin();
  showToast('Admin created');
  renderAll();
}

// initial data variables
let PRODUCTS = readJSON(KEY_PRODUCTS, []);
let BUYERS = readJSON(KEY_BUYERS, []);
let ORDERS = readJSON(KEY_ORDERS, []);

// helper sync from storage
function syncState(){
  PRODUCTS = readJSON(KEY_PRODUCTS, []);
  BUYERS = readJSON(KEY_BUYERS, []);
  ORDERS = readJSON(KEY_ORDERS, []);
  renderAll();
}

// Render functions
function renderAll(){
  renderTopCards();
  renderCategoryOptions();
  applyFilters();
  renderBuyersList();
  renderOrdersList();
  renderSidebarStats();
  renderRecentOrders();
  ensureAdmin();
}

function renderTopCards(){
  document.getElementById('cntProducts').textContent = PRODUCTS.length || 0;
  document.getElementById('cntBuyers').textContent = BUYERS.length || 0;
  document.getElementById('cntOrders').textContent = ORDERS.length || 0;
  const earnings = (ORDERS || []).reduce((s,o)=> s + (Number(o.total||0)), 0);
  document.getElementById('cntEarnings').textContent = '₹' + earnings;
}

function renderCategoryOptions(){
  const sel = document.getElementById('filterCategory');
  const cats = ['__all', ...new Set((PRODUCTS||[]).map(p=>p.category || 'Misc'))];
  sel.innerHTML = cats.map(c=>`<option value="${c}">${c==='__all'?'All categories':c}</option>`).join('');
}

/* Filter + render products list */
let _lastFiltered = [];
function applyFilters(){
  const q = (document.getElementById('searchQ').value || '').trim().toLowerCase();
  const cat = document.getElementById('filterCategory').value;
  const sort = document.getElementById('sortPrice').value;
  let list = (PRODUCTS||[]).slice();
  if(cat && cat !== '__all') list = list.filter(p => (p.category || '').toLowerCase() === (cat || '').toLowerCase());
  if(q) list = list.filter(p => ((p.name||'') + ' ' + (p.category||'') + ' ' + (p.description||'')).toLowerCase().includes(q));
  if(sort === 'price_asc') list.sort((a,b)=> (a.price||0) - (b.price||0));
  if(sort === 'price_desc') list.sort((a,b)=> (b.price||0) - (a.price||0));
  _lastFiltered = list;
  renderGridFromList(list);
}
function resetFilters(){ document.getElementById('searchQ').value = ''; document.getElementById('filterCategory').value='__all'; document.getElementById('sortPrice').value='none'; applyFilters(); }

function renderGridFromList(list){
  const out = document.getElementById('productsList'); out.innerHTML = '';
  if(!list.length){ out.innerHTML = '<p class="kv">No products found</p>'; document.getElementById('productCountInfo').textContent = ''; return; }
  document.getElementById('productCountInfo').textContent = list.length + ' items (filtered)';
  list.slice().reverse().forEach(p=>{
    const img = (p.images && p.images[0]) ? p.images[0] : ('https://via.placeholder.com/160?text='+encodeURIComponent(p.name));
    const div = document.createElement('div'); div.className='list-item';
    div.innerHTML = `
      <img src="${img}" class="img-thumb" alt="">
      <div style="flex:1">
        <strong>${escapeHtml(p.name)}</strong>
        <div class="kv">₹${p.price} · ${p.category || 'Misc'} · stock: ${p.stock || 0}</div>
        <div style="margin-top:6px"><span class="status-pill ${p.status==='active'?'status-active':''}">${(p.status||'active').toUpperCase()}</span> <span class="kv">id:${p.id}</span></div>
      </div>
      <div class="controls">
        <button class="link-btn" onclick="editProduct('${p.id}')">Edit</button>
        <button class="link-btn" onclick="toggleStatus('${p.id}')">${p.status==='active'?'Make Inactive':'Make Active'}</button>
        <button class="link-btn" style="background:#b83d3d;color:#fff" onclick="deleteProduct('${p.id}')">Delete</button>
      </div>
    `;
    out.appendChild(div);
  });
}

/* Buyers list */
function renderBuyersList(){
  const out = document.getElementById('buyersList'); out.innerHTML = '';
  const buyers = (BUYERS||[]);
  if(!buyers.length){ out.innerHTML = '<p class="kv">No buyers yet</p>'; return; }
  buyers.slice().reverse().forEach(b=>{
    const div = document.createElement('div'); div.style.padding='10px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    div.innerHTML = `<strong>${escapeHtml(b.name||'—')}</strong> <div class="kv">${escapeHtml(b.email||'—')} · ${escapeHtml(b.phone||'—')}</div>
      <div class="kv">Last login: ${b.lastLogin ? new Date(b.lastLogin).toLocaleString() : '—'}</div>
      <div style="margin-top:6px"><button class="link-btn" onclick="viewBuyer('${b.id}')">View Details</button> <button class="link-btn" onclick="toggleBlockBuyer('${b.id}')">${b.blocked? 'Unblock':'Block'}</button></div>`;
    if(b.blocked) div.querySelector('strong').classList.add('blocked');
    out.appendChild(div);
  });
}

/* Orders list */
function renderOrdersList(){
  const out = document.getElementById('ordersList'); out.innerHTML = '';
  const orders = (ORDERS||[]);
  if(!orders.length){ out.innerHTML = '<p class="kv">No orders yet</p>'; return; }
  orders.slice().reverse().forEach(o=>{
    const div = document.createElement('div'); div.style.padding='10px'; div.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    const when = new Date(o.date||o.created||Date.now()).toLocaleString();
    const itemsHtml = (o.items||[]).map(i=>`<li>${escapeHtml(i.title||i.name||'Item')} × ${i.qty||1} — ₹${(i.price||i.amount||0)*(i.qty||1)}</li>`).join('');
    div.innerHTML = `<strong>Order ${escapeHtml(String(o.id||('o'+(o._time||Date.now()))))}</strong><div class="kv">${when}</div>
      <div><strong>Buyer:</strong> ${escapeHtml(o.buyerName||o.name||'—')} · ${escapeHtml(o.buyerEmail||o.email||'—')}</div>
      <div><strong>Total:</strong> ₹${o.total || o.amount || 0}</div>
      <div class="small-text" style="margin-top:6px"><strong>Items:</strong></div>
      <ul style="margin:6px 0 0 16px">${itemsHtml}</ul>
      <div style="margin-top:6px"><button class="link-btn" onclick="viewOrder('${escapeHtml(String(o.id||''))}')">View</button></div>`;
    out.appendChild(div);
  });
}

/* Sidebar stats and recent orders */
function renderSidebarStats(){
  const total = PRODUCTS.length;
  const active = PRODUCTS.filter(p=>p.status!=='inactive').length;
  const inactive = total - active;
  document.getElementById('statProducts').textContent = total;
  document.getElementById('statActive').textContent = active;
  document.getElementById('statInactive').textContent = inactive;
  document.getElementById('statBuyers').textContent = BUYERS.length;
  document.getElementById('statOrders').textContent = ORDERS.length;
}
function renderRecentOrders(){
  const el = document.getElementById('recentOrders'); el.innerHTML = '';
  const recent = (ORDERS||[]).slice().reverse().slice(0,6);
  if(!recent.length) { el.innerHTML = '<p class="kv">No recent orders</p>'; return; }
  recent.forEach(o=>{
    const when = new Date(o.date||o.created||Date.now()).toLocaleString();
    const d = document.createElement('div'); d.style.padding='8px'; d.style.borderBottom='1px solid rgba(255,255,255,0.02)';
    d.innerHTML = `<div style="font-weight:700">${escapeHtml(o.buyerName||o.name||'—')}</div><div class="kv">${when}</div><div class="kv">₹${o.total||o.amount||0}</div>`;
    el.appendChild(d);
  });
}

/* ---- CRUD product ---- */
async function saveProduct(){
  const pid = document.getElementById('pid').value;
  const name = (document.getElementById('pname').value||'').trim();
  const price = Number(document.getElementById('pprice').value);
  const category = (document.getElementById('pcat').value||'').trim() || 'Misc';
  const link = (document.getElementById('plink').value||'').trim() || '#';
  const imageUrl = (document.getElementById('pimageurl').value||'').trim();
  const files = document.getElementById('pfiles').files;
  const status = document.getElementById('pstatus').value || 'active';
  const stock = Number(document.getElementById('pstock').value) || 0;

  if(!name || Number.isNaN(price)){ showToast('Name and numeric price required'); return; }

  try{
    let images = [];
    if(imageUrl) images.push(imageUrl);
    if(files && files.length){
      const base64s = await Promise.all(Array.from(files).map(f=> new Promise(res=>{ const fr = new FileReader(); fr.onload = e=>res(e.target.result); fr.readAsDataURL(f); })));
      images = images.concat(base64s);
    }
    if(pid){
      const idx = PRODUCTS.findIndex(x=>String(x.id)===String(pid));
      if(idx>-1){
        PRODUCTS[idx] = {...PRODUCTS[idx], name, price, category, link, images: images.length?images:PRODUCTS[idx].images||[], status, stock, updated: new Date().toISOString()};
        showToast('Product updated');
      } else {
        PRODUCTS.push({ id:pid, name, price, category, link, images: images.length?images:[], status, stock, created:new Date().toISOString() });
        showToast('Product added');
      }
    } else {
      const newid = String(Date.now()) + '_' + Math.floor(Math.random()*9999);
      PRODUCTS.push({ id:newid, name, price, category, link, images: images.length?images:[('https://via.placeholder.com/800x600?text='+encodeURIComponent(name))], status, stock, created:new Date().toISOString() });
      showToast('Product added');
    }
    writeJSON(KEY_PRODUCTS, PRODUCTS);
    clearForm();
    renderAll();
  } catch(err){ console.error(err); showToast('Error saving'); }
}
function editProduct(id){
  const p = PRODUCTS.find(x=>String(x.id)===String(id));
  if(!p){ showToast('Product not found'); return; }
  document.getElementById('pid').value = p.id;
  document.getElementById('pname').value = p.name;
  document.getElementById('pprice').value = p.price;
  document.getElementById('pcat').value = p.category;
  document.getElementById('plink').value = p.link || '';
  document.getElementById('pimageurl').value = (p.images && p.images[0]) || '';
  document.getElementById('pstatus').value = p.status || 'active';
  document.getElementById('pstock').value = p.stock || 0;
  document.getElementById('formTitle').textContent = 'Edit Product';
  window.scrollTo({top:0,behavior:'smooth'});
}
function deleteProduct(id){
  if(!confirm('Delete product?')) return;
  PRODUCTS = PRODUCTS.filter(x=>String(x.id)!==String(id));
  writeJSON(KEY_PRODUCTS, PRODUCTS);
  showToast('Product deleted');
  renderAll();
}
function toggleStatus(id){
  const idx = PRODUCTS.findIndex(x=>String(x.id)===String(id));
  if(idx===-1) return showToast('Not found');
  PRODUCTS[idx].status = (PRODUCTS[idx].status==='inactive') ? 'active' : 'inactive';
  writeJSON(KEY_PRODUCTS, PRODUCTS);
  renderAll();
}
function clearForm(){
  document.getElementById('pid').value=''; document.getElementById('pname').value=''; document.getElementById('pprice').value='';
  document.getElementById('pcat').value=''; document.getElementById('plink').value=''; document.getElementById('pimageurl').value='';
  document.getElementById('pfiles').value=''; document.getElementById('pstatus').value='active'; document.getElementById('pstock').value='100';
  document.getElementById('formTitle').textContent = 'Add / Edit Product';
}

/* ---- Buyers ---- */
function viewBuyer(id){
  const buyers = readJSON(KEY_BUYERS, []);
  const b = buyers.find(x=>String(x.id)===String(id));
  if(!b) return alert('Buyer not found');
  const orders = (readJSON(KEY_ORDERS, [])).filter(o => (o.buyerId && String(o.buyerId) === String(b.id)) || (o.buyerEmail && b.email && o.buyerEmail === b.email));
  let html = `<div style="max-width:720px"><h3>${escapeHtml(b.name||'—')}</h3>`;
  html += `<p><strong>Email:</strong> ${escapeHtml(b.email||'—')}<br><strong>Phone:</strong> ${escapeHtml(b.phone||'—')}<br><strong>Address:</strong> ${escapeHtml(b.address||'—')}</p>`;
  html += `<p><strong>Referral:</strong> ${escapeHtml(b.ref||'—')}<br><strong>Last login:</strong> ${b.lastLogin? new Date(b.lastLogin).toLocaleString() : '—'}</p>`;
  html += `<h4>Orders (${orders.length})</h4><ul>${orders.map(o=>`<li>Order ${escapeHtml(o.id||'—')} — ₹${o.total||0} — ${new Date(o.date||o.created||Date.now()).toLocaleString()}</li>`).join('')}</ul>`;
  html += `</div>`;
  showModal(html);
}
function toggleBlockBuyer(id){
  const buyers = readJSON(KEY_BUYERS, []);
  const idx = buyers.findIndex(x=>String(x.id)===String(id));
  if(idx===-1) return showToast('Buyer not found');
  buyers[idx].blocked = !buyers[idx].blocked;
  writeJSON(KEY_BUYERS, buyers);
  showToast(buyers[idx].blocked ? 'Buyer blocked' : 'Buyer unblocked');
  renderAll();
}

/* ---- Orders ---- */
function viewOrder(id){
  const orders = readJSON(KEY_ORDERS, []);
  const o = orders.find(x=>String(x.id)===String(id));
  if(!o) return showToast('Order not found');
  const itemsHtml = (o.items||[]).map(i=>`<li>${escapeHtml(i.title||i.name||'Item')} × ${i.qty||1} — ₹${(i.price||i.amount||0)*(i.qty||1)}</li>`).join('');
  const html = `<div style="max-width:720px"><h3>Order ${escapeHtml(o.id||'—')}</h3>
    <p><strong>Date:</strong> ${new Date(o.date||o.created||Date.now()).toLocaleString()}</p>
    <p><strong>Buyer:</strong> ${escapeHtml(o.buyerName||o.name||'—')} — ${escapeHtml(o.buyerEmail||o.email||'—')}</p>
    <p><strong>Phone:</strong> ${escapeHtml(o.phone||'—')}</p>
    <p><strong>Address:</strong> ${escapeHtml(o.address||'—')}</p>
    <h4>Items</h4><ul>${itemsHtml}</ul>
    <h4>Total: ₹${o.total || o.amount || 0}</h4></div>`;
  showModal(html);
}

/* ---- Export / Import / Clear ---- */
function exportData(){
  const data = { products: PRODUCTS, buyers: BUYERS, orders: ORDERS };
  const b = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(b);
  const a = document.createElement('a'); a.href = url; a.download = 'b3lams_export_'+Date.now()+'.json'; a.click(); URL.revokeObjectURL(url);
  showToast('Exported JSON');
}
function importPrompt(){
  const inp = document.createElement('input'); inp.type='file'; inp.accept='application/json';
  inp.onchange = e=>{
    const f = e.target.files[0]; if(!f) return;
    const fr = new FileReader();
    fr.onload = () => {
      try{
        const j = JSON.parse(fr.result);
        if(j.products) PRODUCTS = j.products;
        if(j.buyers) BUYERS = j.buyers;
        if(j.orders) ORDERS = j.orders;
        writeJSON(KEY_PRODUCTS, PRODUCTS); writeJSON(KEY_BUYERS, BUYERS); writeJSON(KEY_ORDERS, ORDERS);
        showToast('Imported data');
        renderAll();
      } catch(err){ showToast('Invalid file'); }
    };
    fr.readAsText(f);
  };
  inp.click();
}
function clearAllData(){
  if(!confirm('This will remove PRODUCTS, BUYERS, ORDERS from localStorage. Continue?')) return;
  localStorage.removeItem(KEY_PRODUCTS); localStorage.removeItem(KEY_BUYERS); localStorage.removeItem(KEY_ORDERS);
  PRODUCTS = []; BUYERS = []; ORDERS = [];
  window.dispatchEvent(new Event('storage'));
  renderAll();
  showToast('Cleared data');
}

/* ---- tabs + nav ---- */
function showTab(name){
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+name)?.classList.add('active');
  document.getElementById('section-products').style.display = 'none';
  document.getElementById('section-products-list').style.display = 'none';
  document.getElementById('section-buyers').style.display = 'none';
  document.getElementById('section-orders').style.display = 'none';
  document.getElementById('topCards').style.display = 'flex';
  if(name==='products'){ document.getElementById('section-products').style.display = 'block'; document.getElementById('section-products-list').style.display = 'block'; }
  else if(name==='buyers'){ document.getElementById('section-buyers').style.display = 'block'; }
  else if(name==='orders'){ document.getElementById('section-orders').style.display = 'block'; }
  else if(name==='dashboard'){ document.getElementById('section-products-list').style.display = 'block'; document.getElementById('section-buyers').style.display = 'block'; document.getElementById('section-orders').style.display = 'block'; }
}

/* ---- modal helper ---- */
function showModal(html){
  const mo = document.createElement('div'); mo.className='modal-backdrop'; mo.innerHTML = `<div class="modal-card">${html}<div style="text-align:right;margin-top:12px"><button class="link-btn" onclick="document.body.removeChild(this.closest('.modal-backdrop'))">Close</button></div></div>`; document.body.appendChild(mo);
}

/* ---- small helpers ---- */
function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ---- integrate with buyer app (open link) ---- */
function gotoBuyer(){
  // default buyer URL (update if your buyer app is hosted at different path)
  const buyerUrl = 'https://nallakashasaikumar.github.io/B3L-MSAPP/';
  window.open(buyerUrl, '_blank');
}

function logout(){ localStorage.removeItem(KEY_ADMIN); showToast('Logged out'); location.href='Admin_login.html'; }


/* ---- storage listener to refresh when buyer changes data in another tab/device ---- */
window.addEventListener('storage', (e)=>{
  if([KEY_PRODUCTS, KEY_BUYERS, KEY_ORDERS].includes(e.key) || e.key===null){
    PRODUCTS = readJSON(KEY_PRODUCTS, []);
    BUYERS = readJSON(KEY_BUYERS, []);
    ORDERS = readJSON(KEY_ORDERS, []);
    renderAll();
  }
});

// init: ensure objects are arrays
if(!Array.isArray(PRODUCTS)) PRODUCTS = [];
if(!Array.isArray(BUYERS)) BUYERS = [];
if(!Array.isArray(ORDERS)) ORDERS = [];

// expose functions used inline
window.saveProduct = saveProduct;
window.editProduct = editProduct;
window.deleteProduct = deleteProduct;
window.toggleStatus = toggleStatus;
window.clearForm = clearForm;
window.viewBuyer = viewBuyer;
window.toggleBlockBuyer = toggleBlockBuyer;
window.viewOrder = viewOrder;
window.exportData = exportData;
window.importPrompt = importPrompt;
window.clearAllData = clearAllData;
window.showTab = showTab;
window.applyFilters = applyFilters;
window.resetFilters = resetFilters;

// final render
ensureAdmin();
renderAll();

  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
  }

</script>
</body>
</html>





